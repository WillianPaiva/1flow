{% load endless %}

{% if initial %}

    <li>
        <div class="initial-loading centered">
            <h3 class="loading"><i class="icon-spinner icon-spin icon-large"></i>
                &nbsp;&nbsp;{% trans "Loading entries…" %}</h3>
            <h4 class="thanks1 hide">{% trans "Thanks for your patience." %}</h4>
            <h4 class="thanks-devel hide">{% trans "Oh my GOD, Djangooooo!?" %}</h4>
            <h4 class="thanks2 hide">
                {% trans "Oh my god, something must be wrong?!" %}
            </h4>
            <h4 class="thanks3 hide">
                {% trans "Or do <em>you</em> have <strong>soooo</strong> much to read?" %}
            </h4>
            <h4 class="thanks4 hide">
                {% trans "Anyway, thanks again for you patience." %}
            </h4>
            <h5 class="problem-report hide">{% trans "You shouldn't have waited so long, there must be something wrong with the servers. Could you please contact us to report the problem?" %}</h5>
            <script type="text/javascript">

                setTimeout(function() {
                    try {
                        $('.initial-loading .thanks1').slideDown();
                    } catch (err) {}
                }, 5000);

                {% if debug %}

                    setTimeout(function() {
                        try {
                            $('.initial-loading .thanks1').slideUp();
                            $('.initial-loading .thanks-devel').slideDown();
                        } catch (err) {}
                    }, 9000);

                {% else %}

                    setTimeout(function() {
                        try {
                            $('.initial-loading .thanks1').slideUp();
                            $('.initial-loading .thanks2').slideDown();
                        } catch (err) {}
                    }, 10000);

                    setTimeout(function() {
                        try {
                            $('.initial-loading .thanks2').slideUp();
                            $('.initial-loading .thanks3').slideDown();
                        } catch (err) {}
                    }, 15000);

                    setTimeout(function() {
                        try {
                            $('.initial-loading .thanks3').slideUp();
                            $('.initial-loading .thanks4').slideDown(function(){
                                $('.initial-loading .problem-report').slideDown();
                            });
                        } catch (err) {}
                    }, 20000);

                {% endif %}

            </script>
        </div>
    </li>

    {% comment %}
        At first, I used the lazy paginate mechanism to generate an official
        "show_more" div, to allow the whole mecanism to be completely DRY,
        without creating any exception for the first page.

        But then, the 1st page gets munged and never displays; results start
        at page 2… Besides, instanciating the `lazy_paginate` just for a <div>
        make the first page loading "not so fast", because `endless` is acting.

        Thus, this is a completely fake "show_more". Hard-coded. With this,
        the first page comes blazingly fast, and results are loaded totally
        asynchronously.
    {% endcomment %}

    <div class="endless_container">
        <a class="endless_more" href="{{ request.path }}?page=1"
            rel="page">Charger plus d'articles</a>
        <div class="endless_loading" style="display: none;">Chargement…</div>
    </div>

{% else %}

    {% with items_per_fetch=config.READ_INFINITE_ITEMS_PER_FETCH %}

        {% lazy_paginate items_per_fetch reads %}

            {% for read in reads %}
                {% if read.article.url_absolute and not read.article.duplicate_of %}
                    {% include preferences.home.get_template %}
                {% endif %}
            {% endfor %}

        {% comment %}
            The 'show_more' button is hidden via CSS, don't try to find
            it in the page. But it must be present because it holds the
            necessary data to load the next page.
        {% endcomment %}

        {% show_more _('Load more entries') _('Loading…') %}

    {% endwith %}

{% endif %}
