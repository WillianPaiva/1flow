{% extends 'home.html' %}

{% block title %}{% trans 'Read' %}{% endblock title %}
{% block body_id %}read{% endblock body_id %}

{% block extrajs_header %}
    {{block.super}}
    {% cache 86400 read_status_css_styles %}
        <style type="text/css">{% read_status_css_styles %}</style>
    {% endcache %}
{% endblock extrajs_header %}

{% block application_content %}
{% with home_style=preferences.home.style %}
<div class="row-fluid">
    <div id="reads-list-header" class="span8 offset2">
        <div class="h1-wrapper">
            <div class="h1-background"></div>
            <h1 class="left-side">{{ read_page_header_text_left|safe }}</h1>
            <h1 class="right-side"><span id="reads-number">{{ read_page_header_text_right|safe }}</span></h1>
        </div>
    </div>

    {% comment %}

        <div class="span1">
        <div class="btn-toolbar pull-right">
            <div class="btn-group" data-toggle="buttons-radio">
                <button class="btn preference {% if home_style == 'RL' %}active{% endif %}"
                    data-preference-url="{% url 'set_preference' base='home' sub='style' value='RL' %}"
                    data-preference-value="RL"
                    title=""><i class="icon-list"></i></button>

                <button class="btn preference {% if home_style == 'TL' %}active{% endif %}"
                    data-preference-url="{% url 'set_preference' base='home' sub='style' value='TL' %}"
                    data-preference-value="TL"
                    title=""><i class="icon-th-large"></i></button>

            {% if user.is_superuser %}
                <button class="btn btn-warning preference {% if home_style == 'T1' %}active{% endif %}"
                    data-preference-url="{% url 'set_preference' base='home' sub='style' value='T1' %}"
                    data-preference-value="T1"
                    title="{% trans "Experimental tiles #1" %}"><i class="icon-th"></i></button>

            {% endif %}
            </div>
        </div>
    </div>

    {% endcomment %}

</div>
<div class="row-fluid">
    {% if reads %}
        {% if preferences.home.style == 'RL' %}
            <ul id="reads-container" class="media-list span8 offset2">
                    {% include 'snippets/read/read-endless-page.html' %}
            </ul>

        {% elif preferences.home.style == 'T1' %}
            <div id="reads-container" class="span8 offset2">
                    {% include 'snippets/read/read-endless-page.html' %}
            </div>

        {% else %}
            {# by default, with no preference, we use the TILING mode #}

            <div id="reads-container" class="span8 offset2">
                    {% include 'snippets/read/read-endless-page.html' %}
            </div>
        {% endif %}

    {% else %}
        <div class="hero-unit span8 offset2">
            <h2>{% trans "Nothing to read yet. Buy a book?" %}</h2>
        </div>

    {% endif %}
</div>
{% endwith %}
{% endblock application_content %}

{% block application_footer %}
    {% if preferences.read.show_bottom_navbar %}
        {% include "navbars/read-endless.html" %}
    {% endif %}
{% endblock application_footer %}

{% block extrajs_footer %}
    {{ block.super }}
    {% compressed_js 'read-endless' %}

    <script type="text/javascript">

        {% if debug %}
            // debug_touch = true;
        {% endif %}

        {% include "snippets/read/actions-messages.js.html" %}

        function hide_initial_loading() {

            try {
                $(".initial-loading").stop(true, true).slideUp(function(){
                    // WARNING: do not use sole document.location.
                    // In case of a '#' inside it will loop all the
                    // articles in the counter span!!
                    $.get(document.location.pathname + '?count=1',
                        function(data){
                            $('#reads-number').html(data);
                        }
                    );
                }).delete();

            } catch (err) {
                // nothing, just don't crash if it's not here.
            }
        }

        function show_initial_loading() {

            $(".initial-loading").stop(true, true).fadeIn();
        }

        function show_no_items() {

            $("#no-items").fadeIn();
        }

        function endless_load_next_if_needed() {

            {% comment %}
                When there are un-processed articles, they are skipped and not
                displayed. In that particular case, the reading list page can
                appear nearly empty if there are a lot of them. We compensate
                by fetching one or two more to fill the user view.

                We do this only for the first set of pages, to avoid the fuss
                of selecting and couting a large set of items when the user
                has already scrolled a lot.

                As a side node, the farther he scrolls, the less non-processed
                articles he will encounter, because he gets back in the past.
            {% endcomment %}

            nr_items = $(".read-list-item").length;

            try {
                next_page = parseInt($('.endless_more')
                                     .attr('href').split('=')[1]);

            } catch (err) {
                // no more reads in the endless pagination…
                next_page = null;
            }

            //console.log('next_page: ' + next_page);

            if (nr_items == 0 && next_page == null) {

                hide_initial_loading();

                // no item at all in this list.
                show_no_items();

                return;
            }

            if (next_page == 1) {
                show_initial_loading();
            }

            if (nr_items > 15 || next_page == null) {
                hide_initial_loading();
            }

            if (nr_items < {{ config.READ_INFINITE_ITEMS_PER_FETCH }}) {
                if (next_page != null && next_page <= 5) {
                    console.debug('fetching next page ('
                                  + next_page + ') to fill the view…');

                    $('.endless_container').find('a.endless_more').click();
                }
            }
        }

        function endless_new_page_load_completed(context, fragment) {
            // console.log('Label:', $(this).text());
            //console.log('URL:', context.url);
            //console.log('Querystring key:', context.key);
            // console.log('Fragment:', fragment);

            $('body').find('.endless_container').remove();

            var new_items   = $(fragment);
            var new_endless = new_items.find('.endless_container');

            // NOTE: .after() moved the new_endless.
            // No need to remove it from the fragment.

            reads_container
                .after(new_endless)
                .append(new_items)
            {% if preferences.home.style|slice:'1' == 'T' %}
                .isotope('appended', new_items);
            {% else %}
                ;
            {% endif %}

            setup_everything(new_items);

            console.debug('Finished loading ' + context.url);

            endless_load_next_if_needed();

            // We return false to avoid
            // endless normal processing.
            return false;
        }

        var reads_container = $('#reads-container');
        var last_scroll     = 0;
        var navbar_hidden   = false;
        var preferences = {
            auto_mark_read_delay:       {{ preferences.read.auto_mark_read_delay }},

            {# |lower because JS doesn't like Python's booleans at all. #}
            bookmarked_marks_unread:     {{ preferences.read.bookmarked_marks_unread|lower }},
            starred_marks_read:          {{ preferences.read.starred_marks_read|lower }},
            starred_removes_bookmarked:  {{ preferences.read.starred_removes_bookmarked|lower }},
            read_switches_to_fullscreen: {{ preferences.read.read_switches_to_fullscreen|lower }}
        };

        {% if preferences.home.style|slice:'1' == 'T' %}

            reads_container.isotope({
              itemSelector: '.read-list-item'
            });

        {% endif %}

        $.endlessPaginate({

            {% if config.READ_INFINITE_AUTOSCROLL_ENABLED %}
                paginateOnScroll: true,
                paginateOnScrollMargin: 800,

            {% endif %}

            onCompleted: endless_new_page_load_completed
        });

        reads_container.on('scroll', function() {
            var st = $(this).scrollTop();

            if (st > last_scroll){
                // downward-scrolling

                if (!navbar_hidden) {
                    $('.navbar').slideUp();
                    navbar_hidden = true;
                }
            }  else {
                // upward-scrolling
                if(navbar_hidden) {
                    $('.navbar').slideDown();
                    navbar_hidden = false;
                }
            }

            last_scroll = st;
        });


        endless_load_next_if_needed();

        // ——————————————————————————————————————————— admin and hidden features

        {% include "snippets/read/hidden-features.js.html" with read_id=read.id %}
        {% include "snippets/read/admin-shortcuts.js.html" with read_id=read.id %}

    </script>
{% endblock extrajs_footer %}
